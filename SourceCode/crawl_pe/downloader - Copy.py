import os
import requests
from virusshare import VirusShare
from ratelimit import limits, sleep_and_retry

v = VirusShare('B4MlldeBT0O2gAmBiSXph5CwOb4tAxQM')
# 4 calls per 75s
CALLS = 4
RATE_LIMIT = 75

@sleep_and_retry
@limits(calls=CALLS, period=RATE_LIMIT)
def download_hash(hash, path):
    result = v.download(hash, path)
    return 0
 
parent_folder = "malsam"
 
def download_file(url, folder):
    filename = url.split("/")[-1]
    filepath = os.path.join(folder, filename)
    response = requests.get(url)
    with open(filepath, "wb") as file:
        file.write(response.content)
    print(f"Downloaded {filename} to {folder}")

def process_subfolders(folder):
    count = 1
    for root, subfolders, files in os.walk(folder):
        for subfolder in subfolders:
            subfolder_path = os.path.join(root, subfolder)
            file_name = subfolder + ".txt"
            text_file_path = os.path.join(subfolder_path, file_name)
            if os.path.isfile(text_file_path):
                with open(text_file_path, "r") as file:
                    for line in file:
                        print(count)
                        count += 1
                        print(f'{root}/{subfolder}/{file_name}: {line.rstrip()}')
                        result_path = f'{root}/{subfolder}'
                        if os.path.exists(f'{result_path}/VirusShare_{line.rstrip()}.zip'):
                            print("Downloaded")
                            continue
                        else:
                            print("Now downloading")
                            download_hash(line.rstrip(), result_path)

# Call the function to start processing the subfolders
process_subfolders(parent_folder)

